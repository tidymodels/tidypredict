<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Database write-back • tidypredict</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Database write-back">
<script src="https://cdn.jsdelivr.net/gh/posit-dev/supported-by-posit/js/badge.min.js" data-max-height="43" data-light-bg="#666f76" data-light-fg="#f9f9f9"></script><script defer data-domain="tidypredict.tidymodels.org,all.tidymodels.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">tidypredict</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-model-list" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Model list</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-model-list">
<li><a class="dropdown-item" href="../articles/lm.html">Linear Regression - lm()</a></li>
    <li><a class="dropdown-item" href="../articles/glm.html">Generalized Regression - glm()</a></li>
    <li><a class="dropdown-item" href="../articles/glmnet.html">Regularized Regression - glmnet()</a></li>
    <li><a class="dropdown-item" href="../articles/ranger.html">Random Forest - Ranger - ranger()</a></li>
    <li><a class="dropdown-item" href="../articles/rf.html">Random Forest - randomForest()</a></li>
    <li><a class="dropdown-item" href="../articles/rpart.html">Decision Tree - rpart()</a></li>
    <li><a class="dropdown-item" href="../articles/mars.html">MARS - earth()</a></li>
    <li><a class="dropdown-item" href="../articles/cubist.html">Cubist - cubist()</a></li>
    <li><a class="dropdown-item" href="../articles/xgboost.html">XGboost - xgb.Booster.complete()</a></li>
    <li><a class="dropdown-item" href="../articles/lightgbm.html">LightGBM - lgb.Booster()</a></li>
    <li><a class="dropdown-item" href="../articles/catboost.html">CatBoost - catboost.Model()</a></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/save.html">Save/Reload</a></li>
    <li><a class="dropdown-item" href="../articles/tree-internals.html">How tree formulas work</a></li>
    <li><a class="dropdown-item" href="../articles/float-precision.html">Float precision at split boundaries</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/non-r.html">Non-R models</a></li>
    <li><a class="dropdown-item" href="../articles/regression.html">Regression spec</a></li>
    <li><a class="dropdown-item" href="../articles/tree.html">Tree model spec</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/sql.html">DB Writeback</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tidymodels/tidypredict/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Database write-back</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidymodels/tidypredict/blob/main/vignettes/sql.Rmd" class="external-link"><code>vignettes/sql.Rmd</code></a></small>
      <div class="d-none name"><code>sql.Rmd</code></div>
    </div>

    
    
<p>This article reviews two possible scenarios for “writing back”
predictions to the database, and without importing the data into memory
first. Both scenarios share a common model preparation method.</p>
<div class="section level2">
<h2 id="example-setup">Example setup<a class="anchor" aria-label="anchor" href="#example-setup"></a>
</h2>
<p>To keep the example reproducible, a SQLite database will be used to
simulate a larger scale deployment.</p>
<p>First the data is prepared in memory. The article will use the
<code><a href="https://rdrr.io/pkg/nycflights13/man/flights.html" class="external-link">nycflights13::flights</a></code> data, with a couple of
modifications</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidypredict.tidymodels.org">tidypredict</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.stat.berkeley.edu/~breiman/RandomForests/" class="external-link">randomForest</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbplyr.tidyverse.org/" class="external-link">dbplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">flights_table</span> <span class="op">&lt;-</span> <span class="fu">nycflights13</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/nycflights13/man/flights.html" class="external-link">flights</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    current_score <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    flight_id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>A new database is created using <code>RSQLite</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org" class="external-link">DBI</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>, path <span class="op">=</span> <span class="st">":memory:"</span><span class="op">)</span></span>
<span><span class="va">db_fligths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/copy_to.html" class="external-link">copy_to</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">flights_table</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="model-preparation">Model preparation<a class="anchor" aria-label="anchor" href="#model-preparation"></a>
</h2>
<p>A sample is downloaded from the database for modeling. This example
already selects the needed variables.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">db_fligths</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">dep_delay</span>, <span class="va">hour</span>, <span class="va">distance</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>A linear model is fitted using <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">dep_delay</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">df</span><span class="op">)</span></span></code></pre></div>
<p>It is highly recommendable to always run
<code><a href="../reference/tidypredict_test.html">tidypredict_test()</a></code> to make sure that the predictions are in
line with what the <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> command returns.</p>
<p>The <code>lm</code> and <code>glm</code> models contain the data that
they were fitted with, so it’s easy to run a test.
<code><a href="../reference/tidypredict_test.html">tidypredict_test()</a></code> uses the model’s internal data set by
default</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/tidypredict_test.html">tidypredict_test</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="co">#&gt; tidypredict test results</span></span>
<span><span class="co">#&gt; Difference threshold: 1e-12</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  All results are within the difference threshold</span></span></code></pre></div>
<p>In cases where the model re-fitting is automated, the
<code><a href="../reference/tidypredict_test.html">tidypredict_test()</a></code> function returns an <code>alert</code>
in case the threshold is exceeded, which can be used to fail the
automated script.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/tidypredict_test.html">tidypredict_test</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">$</span><span class="va">alert</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Threshold exceeded!"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="scenario-1---update-scores">Scenario 1 - Update scores<a class="anchor" aria-label="anchor" href="#scenario-1---update-scores"></a>
</h2>
<p>In this scenario, The table that supplies the term values is also the
recipient of the new score. This is done by updating a specific field in
the table. For this example, the field is called
<code>current_score</code>. The following SQL UPDATE statement should
work in most databases:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbplyr.tidyverse.org/" class="external-link">dbplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">update_statement</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/build_sql.html" class="external-link">build_sql</a></span><span class="op">(</span><span class="st">"UPDATE flights_table SET current_score  = "</span>, <span class="fu"><a href="../reference/tidypredict_sql.html">tidypredict_sql</a></span><span class="op">(</span><span class="va">model</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span></span>
<span><span class="va">update_statement</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; UPDATE flights_table SET current_score  = (-3.59844229187029 + (`hour` * 1.38710560882252)) + (`distance` * -0.00307606912118568)</span></span></code></pre></div>
<p>This statement can be then passed on to the database team, via
documentation or an automated process. In cases where the analyst has
the responsibility to run the new SQL statement, or if R is being used
to automate the scoring, the next line can be used:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbSendQuery.html" class="external-link">dbSendQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">update_statement</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQLiteResult&gt;</span></span>
<span><span class="co">#&gt;   SQL  UPDATE flights_table SET current_score  = (-3.59844229187029 + (`hour` * 1.38710560882252)) + (`distance` * -0.00307606912118568)</span></span>
<span><span class="co">#&gt;   ROWS Fetched: 0 [complete]</span></span>
<span><span class="co">#&gt;        Changed: 336776</span></span></code></pre></div>
<p>Here is a sample of the newly populated field:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">db_fligths</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">current_score</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Closing open result set, pending rows</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   SQL [?? x 1]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: sqlite 3.51.2 []</span></span></span>
<span><span class="co">#&gt;    current_score</span></span>
<span><span class="co">#&gt;            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>       -<span style="color: #BB0000;">0.969</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>       -<span style="color: #BB0000;">1.02</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>       -<span style="color: #BB0000;">0.012</span><span style="color: #BB0000; text-decoration: underline;">8</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>       -<span style="color: #BB0000;">1.51</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>        2.38  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>        1.13  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>        1.45  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>        4.02  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>        1.82  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>        2.47</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="scenario-2--append-new-scores">Scenario 2- Append new scores<a class="anchor" aria-label="anchor" href="#scenario-2--append-new-scores"></a>
</h2>
<p>There may be the need to retain not only the new score, but when it
was determined and its history. This is usually possible because the
source of record possesses a unique key identifier per entity, such as
transaction ID or customer ID. In the example, <code>flights_id</code>
is the unique identifier.</p>
<p>In this example, the new scores will be stored in a new table called
<code>daily_scores</code>. The following code is part of the example
preparation, it creates the table and seeds it with a single row. This
is not the best way to create an empty table, but it’ll do for the
purposes of this example.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html" class="external-link">dbWriteTable</a></span><span class="op">(</span></span>
<span>  <span class="va">con</span>, <span class="st">"daily_scores"</span>,</span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    flight_id <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    score <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    date <span class="op">=</span> <span class="st">""</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The plan is to use a SQL statement that most vendors support, is
called INSERT INTO SELECT. The idea is to use <code>dplyr</code>
laziness to prepare the data transformation and predictions, but it’s
not going to be executed until is parsed into SQL and sent as part of a
another statement. The INSERT INTO SELECT statement allows for the
results of a query to be saved in a table, and without leaving the
database.</p>
<p>In this example, predictions are going to be executed for just the
records in the month of December. The data is filtered, and then
<code><a href="../reference/tidypredict_to_column.html">tidypredict_to_column()</a></code> is used to create the new fit
field. The results are then transformed to match to the structure of the
new <code>daily_scores</code> table.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_predictions</span> <span class="op">&lt;-</span> <span class="va">db_fligths</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">month</span> <span class="op">==</span> <span class="fl">12</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/tidypredict_to_column.html">tidypredict_to_column</a></span><span class="op">(</span><span class="va">model</span>, vars <span class="op">=</span> <span class="st">"score"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    <span class="va">flight_id</span>,</span>
<span>    <span class="va">score</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>date <span class="op">=</span> <span class="st">"01/01/2018"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">insert_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/build_sql.html" class="external-link">build_sql</a></span><span class="op">(</span><span class="st">"INSERT INTO daily_scores "</span>, <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/sql_build.html" class="external-link">sql_render</a></span><span class="op">(</span><span class="va">new_predictions</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="va">insert_scores</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; INSERT INTO daily_scores SELECT `q01`.*, '01/01/2018' AS `date`</span></span>
<span><span class="co">#&gt; FROM (</span></span>
<span><span class="co">#&gt;   SELECT</span></span>
<span><span class="co">#&gt;     `flight_id`,</span></span>
<span><span class="co">#&gt;     (-3.59844229187029 + (`hour` * 1.38710560882252)) + (`distance` * -0.00307606912118568) AS `score`</span></span>
<span><span class="co">#&gt;   FROM `flights_table`</span></span>
<span><span class="co">#&gt;   WHERE (`month` = 12.0)</span></span>
<span><span class="co">#&gt; ) AS `q01`</span></span></code></pre></div>
<p>As in the first scenario, this statement can be then passed on to the
database team, via documentation or an automated process. In cases where
the analyst has the responsibility to run the new SQL statement, or if R
is being used to automate the scoring, the next line can be used:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbSendQuery.html" class="external-link">dbSendQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">insert_scores</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQLiteResult&gt;</span></span>
<span><span class="co">#&gt;   SQL  INSERT INTO daily_scores SELECT `q01`.*, '01/01/2018' AS `date`</span></span>
<span><span class="co">#&gt; FROM (</span></span>
<span><span class="co">#&gt;   SELECT</span></span>
<span><span class="co">#&gt;     `flight_id`,</span></span>
<span><span class="co">#&gt;     (-3.59844229187029 + (`hour` * 1.38710560882252)) + (`distance` * -0.00307606912118568) AS `score`</span></span>
<span><span class="co">#&gt;   FROM `flights_table`</span></span>
<span><span class="co">#&gt;   WHERE (`month` = 12.0)</span></span>
<span><span class="co">#&gt; ) AS `q01`</span></span>
<span><span class="co">#&gt;   ROWS Fetched: 0 [complete]</span></span>
<span><span class="co">#&gt;        Changed: 28135</span></span></code></pre></div>
<p>A simple table join can be used to confirm that the new update
worked. For real life scenarios, a more sophisticated query should be
performed in order to only get the latest score. For this example, we
simple filter on the same date we inserted</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"daily_scores"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"flights_table"</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"flight_id"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">==</span> <span class="st">"01/01/2018"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">dep_delay</span>, <span class="va">hour</span>, <span class="va">distance</span>, <span class="va">score</span>, <span class="va">date</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Closing open result set, pending rows</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   SQL [?? x 5]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: sqlite 3.51.2 []</span></span></span>
<span><span class="co">#&gt;    dep_delay  hour distance   score date      </span></span>
<span><span class="co">#&gt;        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>        14    23     <span style="text-decoration: underline;">1</span>617 23.3    01/01/2018</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>        18    23     <span style="text-decoration: underline;">1</span>576 23.5    01/01/2018</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>        -<span style="color: #BB0000;">7</span>     5      529  1.71   01/01/2018</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>         5     5     <span style="text-decoration: underline;">1</span>400 -<span style="color: #BB0000;">0.969</span>  01/01/2018</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>        -<span style="color: #BB0000;">4</span>     5     <span style="text-decoration: underline;">1</span>089 -<span style="color: #BB0000;">0.012</span><span style="color: #BB0000; text-decoration: underline;">8</span> 01/01/2018</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>       -<span style="color: #BB0000;">10</span>     5     <span style="text-decoration: underline;">1</span>576 -<span style="color: #BB0000;">1.51</span>   01/01/2018</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>        -<span style="color: #BB0000;">4</span>     5      569  1.59   01/01/2018</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>         1     5     <span style="text-decoration: underline;">1</span>416 -<span style="color: #BB0000;">1.02</span>   01/01/2018</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>       -<span style="color: #BB0000;">11</span>     6      214  4.07   01/01/2018</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>       -<span style="color: #BB0000;">10</span>     6     <span style="text-decoration: underline;">1</span>065  1.45   01/01/2018</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ more rows</span></span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by Emil Hvitfeldt, Edgar Ruiz, <a href="https://github.com/topepo" class="external-link">Max Kuhn</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

  </div></footer>
</body>
</html>
