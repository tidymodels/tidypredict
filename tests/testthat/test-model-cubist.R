set.seed(100)
data("BostonHousing", package = "mlbench")
model <- Cubist::cubist(
  x = BostonHousing[, -14],
  y = BostonHousing$medv,
  committees = 3
)
tf <- tidypredict_fit(model)
pm <- parse_model(model)

test_that("Returns the correct type and dimensions", {
  expect_s3_class(pm, "list")
  expect_equal(length(pm), 2)
  expect_equal(length(pm$trees), 1)
  expect_equal(pm$general$model, "cubist")
  expect_equal(pm$general$version, 2)
})

test_that("Returns expected dplyr formula", {
  expect_snapshot(
    rlang::expr_text(tf)
  )
})

test_that("Model can be saved and re-loaded", {
  mp <- tempfile(fileext = ".yml")
  yaml::write_yaml(pm, mp)
  l <- yaml::read_yaml(mp)
  pm <- as_parsed_model(l)
  expect_snapshot(tidypredict_fit(pm))
})

test_that("Model can be saved and re-loaded", {
  model <- Cubist::cubist(
    x = BostonHousing[, -14],
    y = BostonHousing$medv,
    committees = 2,
    control = Cubist::cubistControl(rules = 1)
  )
  tf <- tidypredict_fit(model)
  expect_no_error(
    parse_model(model)
  )
})

test_that("intercept is done correctly (#58)", {
  biomass_tr <- modeldata::biomass %>%
    dplyr::filter(dataset == "Training") %>%
    dplyr::select(-dataset, -sample)

  set.seed(1)
  mod <- Cubist::cubist(
    x = biomass_tr %>% dplyr::select(-HHV),
    y = biomass_tr$HHV
  )

  res <- tidypredict_fit(mod)
  expect_false(any(grepl("list", res)))
})

test_that("doesn't divide by TRUE (#143)", {
  rules <- list(quote(37.2 + hp * -0.0318 + wt * -3.88))
  paths <- list(TRUE)

  expect_identical(
    expr_text(make_committee(rules, paths)),
    "37.2 + hp * -0.0318 + wt * -3.88"
  )

  rules <- list(quote(37.2 + hp * -0.0318 + wt * -3.88))
  paths <- list(quote(disp > 95.099998))

  expect_identical(
    expr_text(make_committee(rules, paths)),
    "(37.2 + hp * -0.0318 + wt * -3.88)/(disp > 95.099998)"
  )
})
